rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    // Verifica se o usuário é admin via Custom Claim ou Lista de Email (Fallback Seguro)
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true || 
        request.auth.token.email in ['admin@kombucha.com', 'alessandro@kombistyle.com'] 
      );
    }

    // Verifica se o usuário acessa seu próprio documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- DOMAIN RULES ---

    // 1. Catálogo e Produtos (Público Leitura / Admin Escrita)
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /combos/{comboId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 2. Conteúdo CMS (Blog/Receitas) - FECHAR ESCRITA PÚBLICA
    match /posts/{postId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /recipes/{recipeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 3. Sistema de Logística
    match /deliverySlots/{slotId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 4. Pedidos (Alta Segurança)
    // Clientes podem criar, mas apenas Admins leem todos ou editam status
    // Clientes podem ler APENAS seus próprios pedidos (se houver userId vinculado)
    match /orders/{orderId} {
      allow read: if isAdmin() || (request.auth != null && resource.data.customer.id == request.auth.uid);
      allow create: if true; // Checkout público permitido (Guest Checkout)
      allow update: if isAdmin(); // Apenas admin muda status e pagamentos
      allow delete: if false; // Auditoria: nunca deletar pedidos
    }

    // 5. Clientes
    match /customers/{customerId} {
      allow read, write: if isAdmin(); // Dados sensíveis (PII). Admin gerencia.
    }

    // 6. Inventário e Estoque (Server-Side Only)
    match /inventory/{productId} {
      allow read: if true;
      allow write: if false; // Apenas via Admin SDK (API)
    }
    match /stockMovements/{movementId} {
      allow read, write: if false; // Apenas via Admin SDK (Audit Log)
    }

    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
