rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/memberships/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isStaff() {
      return hasRole('staff') || isAdmin();
    }
    
    function isDriver() {
      return hasRole('driver') || isAdmin();
    }
    
    function isContent() {
      return hasRole('content') || isAdmin();
    }

    // --- Collections ---

    // Memberships
    match /memberships/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId; 
      allow update, delete: if isAdmin();
    }

    // Products (Catalog)
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin() || isContent();
    }
    
    // Settings (Delivery Config)
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Delivery Days
    match /deliveryDays/{date} {
      allow read: if true;
      allow write: if isStaff(); 
    }

    // Inventory
    match /inventory/{productId} {
      allow read: if true;
      allow write: if isStaff(); 
    }
    match /stockMovements/{movementId} {
      allow read: if isStaff();
      allow write: if isStaff();
    }

    // Orders
    match /orders/{orderId} {
      allow create: if true;
      allow read: if isStaff() || isDriver();
      allow update: if isStaff() || isDriver();
      allow delete: if isAdmin();
    }

    // Customers
    match /customers/{phone} {
       allow create, update: if true;
       allow read: if isStaff();
       allow delete: if isAdmin();
    }
    
    // Audit Logs
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }

    // --- CONTENT CMS (Hardened) ---

    // Posts: Public Read (Published Only ideally, but difficult in Rules without exposing draft if filtering matches).
    // Simplification: Allow Read ALL if query limits to status==PUBLISHED? No, Firestore rules don't filter queries.
    // Secure approach: Admin/Content can read all. Public can read ONLY if resource.data.status == 'PUBLISHED'.
    match /posts/{slug} {
      allow read: if (resource.data.status == 'PUBLISHED') || isContent();
      allow write: if isContent();
    }

    // Testimonials: Public Read Approved.
    match /testimonials/{id} {
      allow read: if (resource.data.status == 'APPROVED') || isContent();
      allow write: if isContent() || isStaff(); // Staff can write (manual entry) but ideally strict rules would prevent approve. Rules can't easily validate fields diff without complexity. Trusting Staff for now as per "manual entry" req.
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
